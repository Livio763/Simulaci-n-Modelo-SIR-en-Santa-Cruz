<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gr√°ficos y Ecuaciones - Modelo SIR</title>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f7fafc;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    h1 {
      color: #2d3748;
      text-align: center;
      margin-bottom: 10px;
    }
    
    .sync-status {
      text-align: center;
      padding: 10px;
      background: #c6f6d5;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #22543d;
    }
    
    .sync-status.disconnected {
      background: #fed7d7;
      color: #742a2a;
    }
    
    .chart-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .chart-section h2 {
      margin: 0 0 15px 0;
      color: #2d3748;
      font-size: 20px;
      border-bottom: 2px solid #e53e3e;
      padding-bottom: 10px;
    }
    
    .legend-enhanced {
      background: #f7fafc;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e2e8f0;
      margin: 15px 0;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin: 8px 0;
      font-size: 13px;
      color: #2d3748;
    }
    
    .legend-color {
      width: 40px;
      height: 20px;
      border-radius: 4px;
      margin-right: 12px;
      flex-shrink: 0;
    }
    
    .legend-color-dashed {
      width: 40px;
      height: 20px;
      border-radius: 4px;
      margin-right: 12px;
      flex-shrink: 0;
      background: transparent;
      border: 3px dashed;
    }
    
    #sirChart {
      max-height: 500px;
    }
    
    #equations-display {
      padding: 15px;
      background: #fff5f5;
      border-radius: 6px;
      border-left: 4px solid #e53e3e;
      font-size: 12px;
      line-height: 2;
      color: #2d3748;
      font-family: 'Courier New', monospace;
    }
    
    #equations-display h4 {
      margin: 0 0 10px 0;
      font-size: 15px;
      color: #c53030;
      font-weight: bold;
      font-family: Arial, sans-serif;
    }
    
    #equations-display .eq-line {
      margin: 5px 0;
      padding: 5px 8px;
      background: white;
      border-radius: 3px;
      font-size: 12px;
    }
    
    #equations-display .eq-value {
      color: #e53e3e;
      font-weight: bold;
    }
    
    #equations-display hr {
      border: none;
      border-top: 1px dashed #cbd5e0;
      margin: 10px 0;
    }
    
    .info-note {
      margin-top: 15px;
      padding: 12px;
      background: #fffaf0;
      border-left: 4px solid #d69e2e;
      border-radius: 4px;
      font-size: 13px;
      color: #744210;
    }

    /* Conclusiones */
    .conclusion-good { background: #f0fff4; border-left-color: #38a169; }
    .conclusion-warn { background: #fffff0; border-left-color: #d69e2e; }
    .conclusion-bad  { background: #fff5f5; border-left-color: #e53e3e; }
    .conclusion-list { margin: 0; padding-left: 18px; }
    .conclusion-list li { margin: 6px 0; }
  </style>
</head>
<body>

<div class="container">
  <h1>üìä Gr√°ficos y Ecuaciones - Modelo SIR</h1>
  
  <div id="sync-status" class="sync-status">
    üîÑ Esperando datos de la simulaci√≥n...
  </div>
  
  <div class="chart-section">
    <h2>Evoluci√≥n Principal SIR (S, I, R)</h2>
    <p style="font-size: 12px; color: #718096; margin-bottom: 15px;">
      Compartimientos b√°sicos: Susceptibles, Infectados (Euler) y Recuperados. La soluci√≥n integral se grafica abajo para evitar que su escala oculte a las dem√°s curvas.
    </p>
    
    <div class="legend-enhanced">
      <div class="legend-item">
        <span class="legend-color" style="background: #4299e1;"></span>
        <strong>Susceptibles (S)</strong> - Personas sin infectar
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background: #e53e3e; border: 2px solid #e53e3e;"></span>
        <strong>Infectados - M√©todo Euler (I<sub>Euler</sub>)</strong> - EDO resuelta num√©ricamente (l√≠nea s√≥lida)
      </div>
      
      <div class="legend-item">
        <span class="legend-color" style="background: #38a169;"></span>
        <strong>Recuperados (R)</strong> - Personas que ya tuvieron la enfermedad
      </div>
    </div>
    
    <canvas id="sirChart"></canvas>
    
    <div class="info-note">
      <strong>üìå Nota:</strong> Este panel usa escala lineal y muestra s√≥lo S, I (Euler) y R para una lectura clara. La comparaci√≥n con la soluci√≥n integral est√° en el siguiente panel.
    </div>
  </div>

  <div class="chart-section">
    <h2>Comparaci√≥n Infectados: Euler vs Integral</h2>
    <p style="font-size: 12px; color: #718096; margin-bottom: 15px;">
      EDO (Euler) vs Ecuaci√≥n Integral exacta. La escala del eje Y cambia autom√°ticamente a logar√≠tmica si la diferencia de magnitudes es grande.
    </p>
    <div class="legend-enhanced">
      <div class="legend-item">
        <span class="legend-color" style="background: #e53e3e; border: 2px solid #e53e3e;"></span>
        <strong>Infectados (Euler)</strong> - Integraci√≥n num√©rica de dI/dt
      </div>
      <div class="legend-item">
        <span class="legend-color-dashed" style="border-color: #9f7aea;"></span>
        <strong>Infectados (Integral)</strong> - I(t) = I(0)¬∑e<sup>-Œ≥t</sup> + ‚à´ Œ≤¬∑S¬∑I¬∑e<sup>-Œ≥(t-u)</sup> du
      </div>
    </div>
    <canvas id="integralChart"></canvas>
    <div class="info-note">
      <strong>ÔøΩ Escala:</strong> Autom√°tica (lineal o logar√≠tmica) para evitar que una curva oculte a la otra.
    </div>
  </div>
  
  <div class="chart-section">
    <h2>üìê Ecuaciones del Modelo</h2>
    <div id="equations-display">
      <div class="eq-line" style="color: #718096; font-style: italic;">
        Las ecuaciones se actualizar√°n cuando la simulaci√≥n est√© en ejecuci√≥n...
      </div>
    </div>
  </div>

  <div class="chart-section">
    <h2>üßæ Conclusiones de la simulaci√≥n</h2>
    <div id="conclusion-panel" class="info-note">
      Al terminar la simulaci√≥n, aqu√≠ ver√°s un resumen con el pico de infectados, valores finales (S, I, R), y la comparaci√≥n entre Euler e Integral.
    </div>
  </div>
</div>

<script>
// === Variables globales ===
let sirChart = null;
let integralChart = null;
let updateInterval = null;
let conclusionShown = false;
let lastSeenDay = -1;

// === Inicializar gr√°fico ===
function initializeChart() {
  const ctx = document.getElementById('sirChart').getContext('2d');
  
  sirChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Susceptibles',
          data: [],
          borderColor: '#4299e1',
          backgroundColor: 'rgba(66, 153, 225, 0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true
        },
        {
          label: 'Infectados (Euler)',
          data: [],
          borderColor: '#e53e3e',
          backgroundColor: 'rgba(229, 62, 62, 0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true
        },
        {
          label: 'Recuperados',
          data: [],
          borderColor: '#38a169',
          backgroundColor: 'rgba(56, 161, 105, 0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 2,
      plugins: {
        legend: {
          display: false // Usamos leyenda HTML personalizada
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) label += ': ';
              label += Math.round(context.parsed.y).toLocaleString();
              return label;
            }
          }
        }
      },
      scales: {
        x: {
          title: { 
            display: true, 
            text: 'D√≠as',
            font: { size: 14, weight: 'bold' }
          },
          ticks: { font: { size: 12 } },
          grid: { color: '#e2e8f0' }
        },
        y: {
          title: { 
            display: true, 
            text: 'N√∫mero de Personas',
            font: { size: 14, weight: 'bold' }
          },
          ticks: { 
            font: { size: 12 },
            callback: function(value) {
              if (value >= 1000000) {
                return (value / 1000000).toFixed(1) + 'M';
              }
              return (value / 1000).toFixed(0) + 'k';
            }
          },
          grid: { color: '#e2e8f0' }
        }
      }
    }
  });
  
  // Segundo gr√°fico: comparaci√≥n Euler vs Integral
  const ctxInt = document.getElementById('integralChart').getContext('2d');
  integralChart = new Chart(ctxInt, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Infectados (Euler)',
          data: [],
          borderColor: '#e53e3e',
          backgroundColor: 'rgba(229, 62, 62, 0.05)',
          borderWidth: 2,
          tension: 0.35,
          fill: true
        },
        {
          label: 'Infectados (Integral)',
          data: [],
          borderColor: '#9f7aea',
          backgroundColor: 'rgba(159, 122, 234, 0)',
          borderWidth: 3,
          borderDash: [8, 4],
          tension: 0.35,
          fill: false,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 2,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) label += ': ';
              label += Math.round(context.parsed.y).toLocaleString();
              return label;
            }
          }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'D√≠as', font: { size: 14, weight: 'bold' } },
          ticks: { font: { size: 12 } },
          grid: { color: '#e2e8f0' }
        },
        y: {
          type: 'linear', // cambiaremos din√°micamente
          title: { display: true, text: 'Infectados', font: { size: 14, weight: 'bold' } },
          ticks: {
            font: { size: 12 },
            callback: function(value) {
              if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
              if (value >= 1000) return (value / 1000).toFixed(0) + 'k';
              return value;
            }
          },
          grid: { color: '#e2e8f0' }
        }
      }
    }
  });

  console.log('Gr√°ficos inicializados');
}

// === Actualizar datos desde localStorage ===
function updateFromStorage() {
  try {
    const dataStr = localStorage.getItem('sirData');
    if (!dataStr) return;
    
    const data = JSON.parse(dataStr);
    
    // Actualizar estado de sincronizaci√≥n
    const syncStatus = document.getElementById('sync-status');
    syncStatus.textContent = `‚úÖ Sincronizado - D√≠a ${data.currentDay.toFixed(1)} | Simulaci√≥n activa`;
    syncStatus.className = 'sync-status';
    
    // Actualizar gr√°fico principal (S, I Euler, R)
    if (sirChart && data.history) {
      const sampleRate = Math.max(1, Math.floor(data.history.days.length / 200));
      
      sirChart.data.labels = data.history.days.filter((_, i) => i % sampleRate === 0);
      sirChart.data.datasets[0].data = data.history.totalS.filter((_, i) => i % sampleRate === 0);
      sirChart.data.datasets[1].data = data.history.totalI.filter((_, i) => i % sampleRate === 0);
      sirChart.data.datasets[2].data = data.history.totalR.filter((_, i) => i % sampleRate === 0);
      sirChart.update('none');
    }
    
    // Actualizar gr√°fico de comparaci√≥n Euler vs Integral
    if (integralChart && data.history) {
      const sampleRate = Math.max(1, Math.floor(data.history.days.length / 200));
      integralChart.data.labels = data.history.days.filter((_, i) => i % sampleRate === 0);
      integralChart.data.datasets[0].data = data.history.totalI.filter((_, i) => i % sampleRate === 0);
      if (data.history.totalI_Integral) {
        integralChart.data.datasets[1].data = data.history.totalI_Integral.filter((_, i) => i % sampleRate === 0);
      }

      // Ajuste autom√°tico de escala: log si integral >> euler
      const eulerMax = Math.max(1, ...integralChart.data.datasets[0].data);
      const integralMax = Math.max(1, ...integralChart.data.datasets[1].data);
      const ratio = integralMax / eulerMax;
      const type = ratio > 100 ? 'logarithmic' : 'linear';
      if (integralChart.options.scales.y.type !== type) {
        integralChart.options.scales.y.type = type;
      }
      integralChart.update('none');
    }
    
    // Actualizar ecuaciones
    if (data.equations) {
      document.getElementById('equations-display').innerHTML = data.equations;
    }

    // Gestionar conclusiones
    if (lastSeenDay !== data.currentDay) {
      // Si se reinicia una simulaci√≥n, limpiar conclusiones
      if (data.currentDay < 1 && conclusionShown) {
        const panel = document.getElementById('conclusion-panel');
        panel.className = 'info-note';
        panel.innerHTML = 'Al terminar la simulaci√≥n, aqu√≠ ver√°s un resumen con el pico de infectados, valores finales (S, I, R), y la comparaci√≥n entre Euler e Integral.';
        conclusionShown = false;
      }
      lastSeenDay = data.currentDay;
    }

    // Mostrar conclusi√≥n autom√°ticamente cuando llegue al final (>= 120 d√≠as)
    if (!conclusionShown && data.history && data.history.days && data.history.days.length > 0 && data.currentDay >= 120) {
      renderConclusion(data);
      conclusionShown = true;
    }
    
  } catch (error) {
    console.error('Error al actualizar datos:', error);
    const syncStatus = document.getElementById('sync-status');
    syncStatus.textContent = '‚ùå Error de sincronizaci√≥n';
    syncStatus.className = 'sync-status disconnected';
  }
}

// === Conclusiones ===
function formatNum(n) {
  return Math.round(n).toLocaleString();
}

function renderConclusion(data) {
  const panel = document.getElementById('conclusion-panel');

  const days = data.history.days || [];
  const S = data.history.totalS || [];
  const I_e = data.history.totalI || [];
  const R = data.history.totalR || [];
  const I_int = data.history.totalI_Integral || [];

  const len = Math.min(days.length, I_e.length);
  const lenInt = Math.min(len, I_int.length);

  // Pico (Euler)
  let peakI = 0, peakDay = 0;
  for (let i = 0; i < len; i++) {
    if (I_e[i] > peakI) { peakI = I_e[i]; peakDay = days[i]; }
  }

  // Valores finales
  const lastIdx = len - 1;
  const S_f = lastIdx >= 0 ? S[lastIdx] : 0;
  const I_e_f = lastIdx >= 0 ? I_e[lastIdx] : 0;
  const R_f = lastIdx >= 0 ? R[lastIdx] : 0;
  const I_int_f = lenInt > 0 ? I_int[lenInt - 1] : 0;

  // Comparaci√≥n Euler vs Integral
  let mape = 0, maxRel = 0, count = 0;
  for (let i = 0; i < lenInt; i++) {
    const e = Math.abs(I_e[i] - I_int[i]);
    const base = I_e[i] > 0 ? I_e[i] : (I_int[i] > 0 ? I_int[i] : 1);
    const rel = e / base;
    mape += rel;
    if (rel > maxRel) maxRel = rel;
    count++; 
  }
  mape = count ? (mape / count) : 0;

  // Juicio cualitativo
  let quality = 'alta', cls = 'conclusion-good';
  if (mape >= 0.15) { quality = 'baja'; cls = 'conclusion-bad'; }
  else if (mape >= 0.05) { quality = 'moderada'; cls = 'conclusion-warn'; }

  const R0 = typeof data.R0 === 'number' ? data.R0 : NaN;
  const dinamica = isNaN(R0) ? '' : (R0 > 1 ? 'El brote crece inicialmente (R‚ÇÄ > 1) y alcanza un pico.' : 'La epidemia tiende a extinguirse (R‚ÇÄ < 1).');

  panel.className = `info-note ${cls}`;
  panel.innerHTML = `
    <div style="font-weight: bold; margin-bottom: 6px;">Resumen final (t = ${days[lastIdx]?.toFixed?.(0) ?? 0} d√≠as)</div>
    <ul class="conclusion-list">
      <li><strong>Pico de infectados (Euler):</strong> ${formatNum(peakI)} personas en el d√≠a ${Math.round(peakDay)}</li>
      <li><strong>Valores finales:</strong> S = ${formatNum(S_f)}, I<sub>Euler</sub> = ${formatNum(I_e_f)}, R = ${formatNum(R_f)}${lenInt?`, I<sub>Integral</sub> = ${formatNum(I_int_f)}`:''}</li>
      <li><strong>Concordancia Euler vs Integral:</strong> ${quality} (error medio ‚âà ${(mape*100).toFixed(2)}%, error m√°x ‚âà ${(maxRel*100).toFixed(2)}%)</li>
      ${dinamica ? `<li><strong>Din√°mica estimada:</strong> ${dinamica} R‚ÇÄ = ${R0.toFixed(2)}</li>` : ''}
    </ul>
    <div style="font-size:12px; color:#4a5568; margin-top:8px;">Interpretaci√≥n: una concordancia ${quality} indica que la integraci√≥n num√©rica por Euler reproduce ${quality==='alta'?'adecuadamente':'con limitaciones'} la soluci√≥n integral durante el periodo simulado.</div>
  `;
}

// === Inicializar ===
initializeChart();

// Actualizar cada 500ms
updateInterval = setInterval(updateFromStorage, 500);

// Actualizar inmediatamente
updateFromStorage();

console.log('=== Ventana de Gr√°ficos Inicializada ===');
console.log('Sincronizando con ventana principal...');
</script>

</body>
</html>
